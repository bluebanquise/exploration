{% extends "main.j2" %}


{% block controlbar %}
  <span style="color: var(--overlord-hover-accent); font-weight: bold;">Trace</span> 
  <span style="margin-left: 8px;"><a href="/inventory">Inventory</a> / <a href="/inventory/group">Host</a> / Add</span>
{% endblock %}

{% block headertitle %}
  <h1 class="title is-4">Add Host</h1>
  <p class="subtitle is-6">Add a new host in the inventory.</p>
{% endblock %}

{% block content %}

<div id="missing-groups-warning"></div>

<div class="box" style="max-width: 700px;">

  <h2 class="subtitle">Host IDs</h2>

  <!-- Hostname -->
  <div class="field">
    <label class="label">Hostname</label>
    <div class="control">
      <input id="hostname" class="input" type="text" placeholder="node01">
    </div>
  </div>

  <!-- Alias -->
  <div class="field">
    <label class="label">Alias</label>
    <div class="control">
      <input id="alias" class="input" type="text" placeholder="compute01">
    </div>
  </div>

</div>

<div class="box" style="max-width: 700px;">

  <!-- Groups Section -->
  <h2 class="subtitle">Groups</h2>

    <div class="field">
    <label class="label">Function group</label>
    <div class="select is-fullwidth">
        <select id="group_function"></select>
    </div>
    </div>

    <div class="field">
    <label class="label">OS group</label>
    <div class="select is-fullwidth">
        <select id="group_os"></select>
    </div>
    </div>

    <div class="field">
    <label class="label">Hardware group</label>
    <div class="select is-fullwidth">
        <select id="group_hardware"></select>
    </div>
    </div>

    <div class="field">
    <label class="label">Rack group (optional)</label>
    <div class="select is-fullwidth">
        <select id="group_rack">
        <option value="">(none)</option>
        </select>
    </div>
    </div>

</div>

<div class="box" style="max-width: 700px;">

  <!-- BMC Section -->
  <h2 class="subtitle">BMC</h2>

  <div class="field">
    <label class="label">BMC Name</label>
    <input id="bmc_name" class="input" type="text" placeholder="bmc-node01">
  </div>

  <div class="field">
    <label class="label">BMC Network</label>
    <input id="bmc_network" class="input" type="text" placeholder="admin">
  </div>

  <div class="field">
    <label class="label">BMC MAC</label>
    <input id="bmc_mac" class="input" type="text" placeholder="aa:bb:cc:dd:ee:ff">
  </div>

  <div class="field">
    <label class="label">BMC IPv4</label>
    <input id="bmc_ip4" class="input" type="text" placeholder="10.0.0.10">
  </div>

</div>

<div class="box" style="max-width: 700px;">

  <!-- Network Interfaces -->
  <h2 class="subtitle">Network Interfaces</h2>

  <div id="interfaces-container"></div>

  <button class="button is-small is-link" onclick="addInterface()">Add new network interface</button>

</div>


  <button id="create-host-btn" class="button is-primary" onclick="addHost()">Add Host</button>

<script>
function addInterface(initial = {}) {
    const container = document.getElementById("interfaces-container");

    const idx = container.children.length;

    const div = document.createElement("div");
    div.className = "box";
    div.style = "margin-bottom: 1rem;";

    div.innerHTML = `
        <h3 class="subtitle">Interface #${idx + 1}</h3>

        <div class="field">
            <label class="label">Interface Name</label>
            <input class="input iface-interface" type="text" value="${initial.interface || ""}">
        </div>

        <div class="field">
            <label class="label">Network</label>
            <input class="input iface-network" type="text" value="${initial.network || ""}">
        </div>

        <div class="field">
            <label class="label">MAC</label>
            <input class="input iface-mac" type="text" value="${initial.mac || ""}">
        </div>

        <div class="field">
            <label class="label">IPv4</label>
            <input class="input iface-ip4" type="text" value="${initial.ip4 || ""}">
        </div>

        <button class="button is-small is-danger" onclick="deleteInterface(this)">Delete interface</button>
    `;

    container.appendChild(div);
}

function deleteInterface(button) {
    const box = button.closest(".box");
    box.remove();
}

async function addHostToGroup(groupName, hostName) {
    await apiRequest("PUT", `/api/v1/inventory/group/${groupName}/hosts/`, {
        host: hostName
    });
}

async function addHost() {
    const hostname = document.getElementById("hostname").value.trim();
    const alias = document.getElementById("alias").value.trim();
    const functionGroup = document.getElementById("group_function").value;
    const osGroup = document.getElementById("group_os").value;
    const hardwareGroup = document.getElementById("group_hardware").value;
    const rackGroup = document.getElementById("group_rack").value; // optional

    if (!hostname) {
        showNotification("is-danger", "Hostname is required");
        return;
    }

    // BMC
    const bmc = {
        name: document.getElementById("bmc_name").value.trim(),
        network: document.getElementById("bmc_network").value.trim(),
        mac: document.getElementById("bmc_mac").value.trim(),
        ip4: document.getElementById("bmc_ip4").value.trim(),
    };

    // Network interfaces
    const interfaces = [];
    const container = document.getElementById("interfaces-container");

    for (const box of container.children) {
        interfaces.push({
            interface: box.querySelector(".iface-interface").value.trim(),
            network: box.querySelector(".iface-network").value.trim(),
            mac: box.querySelector(".iface-mac").value.trim(),
            ip4: box.querySelector(".iface-ip4").value.trim(),
        });
    }

    // 1. Add host
    await apiRequest("POST", "/api/v1/inventory/host", {
        [hostname]: {
            alias: alias,
            bmc: bmc,
            network_interfaces: interfaces
        }
    });

    // 2. Add host to each selected group
    await addHostToGroup(functionGroup, hostname);
    await addHostToGroup(osGroup, hostname);
    await addHostToGroup(hardwareGroup, hostname);
    if (rackGroup) {
        await addHostToGroup(rackGroup, hostname);
    }

    window.location.href = "/inventory/host/list";
}
</script>

<script>
function detectType(name) {
    if (name.startsWith("fn_")) return "function";
    if (name.startsWith("os_")) return "os";
    if (name.startsWith("hw_")) return "hardware";
    if (name.startsWith("rack_")) return "rack";
    return "custom";
}

async function loadGroupsForHost() {
    const data = await apiRequest("GET", "/api/v1/inventory/group");
    const groups = data.groups || {};

    const functionGroups = [];
    const osGroups = [];
    const hardwareGroups = [];
    const rackGroups = [];

    // Classify groups
    for (const name of Object.keys(groups)) {
        const type = detectType(name);
        if (type === "function") functionGroups.push(name);
        if (type === "os") osGroups.push(name);
        if (type === "hardware") hardwareGroups.push(name);
        if (type === "rack") rackGroups.push(name);
    }

    // Fill selects
    fillSelect("group_function", functionGroups);
    fillSelect("group_os", osGroups);
    fillSelect("group_hardware", hardwareGroups);
    fillSelect("group_rack", rackGroups, true);

    // Show warnings if needed
    const warnings = [];
    if (functionGroups.length === 0) warnings.push("a function");
    if (osGroups.length === 0) warnings.push("an OS");
    if (hardwareGroups.length === 0) warnings.push("a hardware");

    const warningBox = document.getElementById("missing-groups-warning");

    if (warnings.length > 0) {
        warningBox.innerHTML = warnings
            .map(w => `<div class="notification is-warning">
                To add a new host, you first need to create ${w} group.
            </div><br>`)
            .join("");

        // Disable create button
        document.getElementById("create-host-btn").disabled = true;
    } else {
        warningBox.innerHTML = "";
        document.getElementById("create-host-btn").disabled = false;
    }
}

function fillSelect(id, items, allowEmpty = false) {
    const select = document.getElementById(id);
    select.innerHTML = "";

    if (allowEmpty) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "(none)";
        select.appendChild(opt);
    }

    items.forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        select.appendChild(opt);
    });
}

loadGroupsForHost();
</script>

{% endblock %}
