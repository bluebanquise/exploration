{% extends "main.j2" %}

{% block content %}
<h1 class="title">Add Host</h1>

<div class="box" style="max-width: 700px;">

  <!-- Hostname -->
  <div class="field">
    <label class="label">Hostname</label>
    <div class="control">
      <input id="hostname" class="input" type="text" placeholder="node01">
    </div>
  </div>

  <!-- Alias -->
  <div class="field">
    <label class="label">Alias</label>
    <div class="control">
      <input id="alias" class="input" type="text" placeholder="compute01">
    </div>
  </div>

  <hr>

  <!-- BMC Section -->
  <h2 class="subtitle">BMC</h2>

  <div class="field">
    <label class="label">BMC Name</label>
    <input id="bmc_name" class="input" type="text" placeholder="bmc-node01">
  </div>

  <div class="field">
    <label class="label">BMC Network</label>
    <input id="bmc_network" class="input" type="text" placeholder="admin">
  </div>

  <div class="field">
    <label class="label">BMC MAC</label>
    <input id="bmc_mac" class="input" type="text" placeholder="aa:bb:cc:dd:ee:ff">
  </div>

  <div class="field">
    <label class="label">BMC IPv4</label>
    <input id="bmc_ip4" class="input" type="text" placeholder="10.0.0.10">
  </div>

  <hr>

  <!-- Network Interfaces -->
  <h2 class="subtitle">Network Interfaces</h2>

  <div id="interfaces-container"></div>

  <button class="button is-small is-link" onclick="addInterface()">Add new network interface</button>

  <hr>

  <button class="button is-primary" onclick="addHost()">Add Host</button>
</div>

<script>
function addInterface(initial = {}) {
    const container = document.getElementById("interfaces-container");

    const idx = container.children.length;

    const div = document.createElement("div");
    div.className = "box";
    div.style = "margin-bottom: 1rem;";

    div.innerHTML = `
        <h3 class="subtitle">Interface #${idx + 1}</h3>

        <div class="field">
            <label class="label">Interface Name</label>
            <input class="input iface-interface" type="text" value="${initial.interface || ""}">
        </div>

        <div class="field">
            <label class="label">Network</label>
            <input class="input iface-network" type="text" value="${initial.network || ""}">
        </div>

        <div class="field">
            <label class="label">MAC</label>
            <input class="input iface-mac" type="text" value="${initial.mac || ""}">
        </div>

        <div class="field">
            <label class="label">IPv4</label>
            <input class="input iface-ip4" type="text" value="${initial.ip4 || ""}">
        </div>

        <button class="button is-small is-danger" onclick="deleteInterface(this)">Delete interface</button>
    `;

    container.appendChild(div);
}

function deleteInterface(button) {
    const box = button.closest(".box");
    box.remove();
}

async function addHost() {
    const hostname = document.getElementById("hostname").value.trim();
    const alias = document.getElementById("alias").value.trim();

    if (!hostname) {
        showNotification("is-danger", "Hostname is required");
        return;
    }

    // BMC
    const bmc = {
        name: document.getElementById("bmc_name").value.trim(),
        network: document.getElementById("bmc_network").value.trim(),
        mac: document.getElementById("bmc_mac").value.trim(),
        ip4: document.getElementById("bmc_ip4").value.trim(),
    };

    // Network interfaces
    const interfaces = [];
    const container = document.getElementById("interfaces-container");

    for (const box of container.children) {
        interfaces.push({
            interface: box.querySelector(".iface-interface").value.trim(),
            network: box.querySelector(".iface-network").value.trim(),
            mac: box.querySelector(".iface-mac").value.trim(),
            ip4: box.querySelector(".iface-ip4").value.trim(),
        });
    }

    await apiRequest("POST", "/api/v1/inventory/host", {
        [hostname]: {
            alias: alias,
            bmc: bmc,
            network_interfaces: interfaces
        }
    });

    window.location.href = "/inventory/host/list";
}
</script>
{% endblock %}
