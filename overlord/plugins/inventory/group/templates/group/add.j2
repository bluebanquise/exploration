{% extends "main.j2" %}

{% block content %}
<h1 class="title">Add Group</h1>

<div class="box" style="max-width: 900px;">

  <!-- Group name -->
  <div class="field">
    <label class="label">Group name</label>
    <div class="control">
      <input id="group_name" class="input" type="text" placeholder="webservers">
    </div>
  </div>

  <!-- Group type -->
  <div class="field">
    <label class="label">Group type</label>
    <div class="control">
      <div class="select">
        <select id="group_type" onchange="onGroupTypeChange()">
          <option value="function">Function group</option>
          <option value="os">Operating System group</option>
          <option value="hardware">Hardware group</option>
          <option value="rack">Rack group</option>
          <option value="custom">Custom group</option>
        </select>
      </div>
    </div>
  </div>

  <hr>

  <!-- Function group has no extra fields beyond name -->

  <!-- OS group section -->
  <div id="os-section" style="display: none;">
    <h2 class="subtitle">Operating System settings</h2>

    <div class="field">
      <label class="label">Distribution</label>
      <input id="os_distribution" class="input" type="text" value="ubuntu">
    </div>

    <div class="field">
      <label class="label">Distribution version</label>
      <input id="os_distribution_version" class="input" type="text" value="24.04">
    </div>

    <div class="field">
      <label class="label">Distribution major version</label>
      <input id="os_distribution_major_version" class="input" type="text" value="24">
    </div>

    <div class="field">
      <label class="label">Keyboard layout</label>
      <input id="os_keyboard_layout" class="input" type="text" value="us">
    </div>

    <div class="field">
      <label class="label">System language</label>
      <input id="os_system_language" class="input" type="text" value="en_US.UTF-8">
    </div>

    <div class="field">
      <label class="label">Firewall</label>
      <div class="select">
        <select id="os_firewall">
          <option value="true" selected>true</option>
          <option value="false">false</option>
        </select>
      </div>
    </div>

    <div class="field">
      <label class="label">Access control</label>
      <div class="select">
        <select id="os_access_control">
          <option value="enforcing" selected>enforcing</option>
          <option value="disabled">disabled</option>
        </select>
      </div>
    </div>

    <div class="field">
      <label class="label">Admin password (SHA512)</label>
      <input id="os_admin_password_sha512" class="input" type="text">
    </div>

    <div class="field">
      <label class="label">Admin SSH keys</label>
      <div id="ssh-keys-container"></div>
      <button class="button is-small is-link" type="button" onclick="addSshKeyField()">Add SSH key</button>
    </div>

    <div class="field">
      <label class="label">Partitioning (YAML or large text)</label>
      <textarea id="os_partitioning" class="textarea" rows="6"></textarea>
    </div>

    <div class="field">
      <label class="label">Kernel parameters</label>
      <textarea id="os_kernel_parameters" class="textarea" rows="4"></textarea>
    </div>
  </div>

  <!-- Hardware group section -->
  <div id="hardware-section" style="display: none;">
    <h2 class="subtitle">Hardware settings</h2>

    <div class="field">
      <label class="label">Equipment type</label>
      <input id="hw_equipment_type" class="input" type="text" placeholder="blade, rack, node">
    </div>

    <h3 class="subtitle">CPU specs</h3>

    <div class="field">
      <label class="label">CPU name</label>
      <input id="hw_cpu_name" class="input" type="text">
    </div>

    <div class="field">
      <label class="label">Cores</label>
      <input id="hw_cpu_cores" class="input" type="number" min="1">
    </div>

    <div class="field">
      <label class="label">Cores per socket</label>
      <input id="hw_cpu_cores_per_socket" class="input" type="number" min="1">
    </div>

    <div class="field">
      <label class="label">Sockets</label>
      <input id="hw_cpu_sockets" class="input" type="number" min="1">
    </div>

    <div class="field">
      <label class="label">Threads per core</label>
      <input id="hw_cpu_threads_per_core" class="input" type="number" min="1">
    </div>

    <div class="field">
      <label class="label">GPU (YAML or list)</label>
      <textarea id="hw_gpu" class="textarea" rows="4" placeholder="- name: A100&#10;- name: V100"></textarea>
    </div>

    <div class="field">
      <label class="label">Console</label>
      <input id="hw_console" class="input" type="text" placeholder="ipmi, redfish, etc.">
    </div>

    <h3 class="subtitle">Board authentication</h3>

    <div class="field">
      <label class="label">Authentication entries (YAML)</label>
      <textarea id="hw_board_authentication" class="textarea" rows="4"
        placeholder="- protocol: ipmi&#10;  user: admin&#10;  password: changeme"></textarea>
    </div>
  </div>

  <!-- Rack group: only name, no extra fields -->

  <!-- Custom group section -->
  <div id="custom-section" style="display: none;">
    <h2 class="subtitle">Custom variables (YAML)</h2>
    <textarea id="custom_vars" class="textarea" rows="8" placeholder="some_var: value&#10;another_var: 42"></textarea>
  </div>

  <hr>

  <button class="button is-primary" onclick="createGroup()">Create group</button>
</div>

<script>
function onGroupTypeChange() {
    const type = document.getElementById("group_type").value;

    document.getElementById("os-section").style.display = (type === "os") ? "block" : "none";
    document.getElementById("hardware-section").style.display = (type === "hardware") ? "block" : "none";
    document.getElementById("custom-section").style.display = (type === "custom") ? "block" : "none";
}

function addSshKeyField(initial = "") {
    const container = document.getElementById("ssh-keys-container");

    const div = document.createElement("div");
    div.className = "field";
    div.innerHTML = `
        <div class="control" style="display: flex; gap: 0.5rem;">
            <input class="input ssh-key-input" type="text" value="${initial}">
            <button class="button is-small is-danger" type="button" onclick="removeSshKeyField(this)">X</button>
        </div>
    `;

    container.appendChild(div);
}

function removeSshKeyField(button) {
    const field = button.closest(".field");
    field.remove();
}

async function createGroup() {
    const name = document.getElementById("group_name").value.trim();
    const groupType = document.getElementById("group_type").value;

    if (!name) {
        showNotification("is-danger", "Group name is required");
        return;
    }

    const payload = {
        name: name,
        group_type: groupType
    };

    if (groupType === "os") {
        const sshKeys = [];
        document.querySelectorAll("#ssh-keys-container .ssh-key-input").forEach(input => {
            const v = input.value.trim();
            if (v) sshKeys.push(v);
        });

        payload.os_operating_system = {
            distribution: document.getElementById("os_distribution").value.trim(),
            distribution_version: document.getElementById("os_distribution_version").value.trim(),
            distribution_major_version: document.getElementById("os_distribution_major_version").value.trim(),
        };
        payload.os_keyboard_layout = document.getElementById("os_keyboard_layout").value.trim();
        payload.os_system_language = document.getElementById("os_system_language").value.trim();
        payload.os_firewall = document.getElementById("os_firewall").value === "true";
        payload.os_access_control = document.getElementById("os_access_control").value;
        payload.os_admin_password_sha512 = document.getElementById("os_admin_password_sha512").value.trim();
        payload.os_admin_ssh_keys = sshKeys;
        payload.os_partitioning = document.getElementById("os_partitioning").value;
        payload.os_kernel_parameters = document.getElementById("os_kernel_parameters").value;
    } else if (groupType === "hardware") {
        payload.hw_equipment_type = document.getElementById("hw_equipment_type").value.trim();
        payload.hw_specs = {
            cpu: {
                name: document.getElementById("hw_cpu_name").value.trim(),
                cores: document.getElementById("hw_cpu_cores").value || null,
                cores_per_socket: document.getElementById("hw_cpu_cores_per_socket").value || null,
                sockets: document.getElementById("hw_cpu_sockets").value || null,
                threads_per_core: document.getElementById("hw_cpu_threads_per_core").value || null,
            },
            // gpu and other complex fields stored as raw text; you can parse YAML later if desired
            gpu: document.getElementById("hw_gpu").value,
        };
        payload.hw_console = document.getElementById("hw_console").value.trim();
        payload.hw_board_authentication = document.getElementById("hw_board_authentication").value;
    } else if (groupType === "custom") {
        payload.custom_vars = document.getElementById("custom_vars").value;
    } else if (groupType === "function") {
        // no extra fields
    } else if (groupType === "rack") {
        // no extra fields
    }

    await apiRequest("POST", "/api/v1/inventory/group", payload);
    window.location.href = "/inventory/group/list";
}

// Initialize defaults
onGroupTypeChange();
</script>
{% endblock %}
