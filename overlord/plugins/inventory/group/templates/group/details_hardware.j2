{% extends "main.j2" %}

{% block content %}
<h1 class="title">Edit Hardware group: {{ name }}</h1>

<div id="hw-box" class="box" style="max-width: 800px;">
  Loading...
</div>

<script>
async function loadGroup() {
    const data = await apiRequest("GET", "/api/v1/inventory/group/{{ name }}");
    const g = data.groups["{{ name }}"]["vars"]["hardware"];
    const hw = g.hw_specs || {};
    const cpu = hw.cpu || {};

    const container = document.getElementById("hw-box");

    container.innerHTML = `
        <div class="field">
            <label class="label">Group name</label>
            <input class="input" type="text" value="{{ name }}" disabled>
        </div>

        <hr>

        <h2 class="subtitle">Hardware settings</h2>

        <div class="field">
            <label class="label">Equipment type</label>
            <input id="hw_equipment_type" class="input" type="text" value="${g.hw_equipment_type || ""}">
        </div>

        <h3 class="subtitle">CPU specs</h3>

        <div class="field">
            <label class="label">CPU name</label>
            <input id="hw_cpu_name" class="input" type="text" value="${cpu.name || ""}">
        </div>

        <div class="field">
            <label class="label">Cores</label>
            <input id="hw_cpu_cores" class="input" type="number" value="${cpu.cores || ""}">
        </div>

        <div class="field">
            <label class="label">Cores per socket</label>
            <input id="hw_cpu_cores_per_socket" class="input" type="number" value="${cpu.cores_per_socket || ""}">
        </div>

        <div class="field">
            <label class="label">Sockets</label>
            <input id="hw_cpu_sockets" class="input" type="number" value="${cpu.sockets || ""}">
        </div>

        <div class="field">
            <label class="label">Threads per core</label>
            <input id="hw_cpu_threads_per_core" class="input" type="number" value="${cpu.threads_per_core || ""}">
        </div>

        <div class="field">
            <label class="label">GPU (YAML)</label>
            <textarea id="hw_gpu" class="textarea" rows="4">${hw.gpu || ""}</textarea>
        </div>

        <div class="field">
            <label class="label">Console</label>
            <input id="hw_console" class="input" type="text" value="${g.hw_console || ""}">
        </div>

        <h3 class="subtitle">Board authentication</h3>

        <div class="field">
            <label class="label">Authentication entries (YAML)</label>
            <textarea id="hw_board_authentication" class="textarea" rows="4">${g.hw_board_authentication || ""}</textarea>
        </div>

        <button class="button is-primary" onclick="saveGroup()">Save</button>
    `;
}

async function saveGroup() {
    await apiRequest("PUT", "/api/v1/inventory/group/{{ name }}", {
        [name]: {
            group_type: "hardware",
            vars: {
                hardware: {
                    hw_equipment_type: document.getElementById("hw_equipment_type").value.trim(),
                    hw_specs: {
                        cpu: {
                            name: document.getElementById("hw_cpu_name").value.trim(),
                            cores: document.getElementById("hw_cpu_cores").value,
                            cores_per_socket: document.getElementById("hw_cpu_cores_per_socket").value,
                            sockets: document.getElementById("hw_cpu_sockets").value,
                            threads_per_core: document.getElementById("hw_cpu_threads_per_core").value,
                        },
                        gpu: document.getElementById("hw_gpu").value,
                    },
                    hw_console: document.getElementById("hw_console").value.trim(),
                    hw_board_authentication: document.getElementById("hw_board_authentication").value,
                }
            }
        }

    });

    window.location.href = "/inventory/group/list";
}

loadGroup();
</script>
{% endblock %}
