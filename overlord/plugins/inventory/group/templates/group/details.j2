{% extends "main.j2" %}

{% block content %}
<h1 class="title">Group Details: {{ name }}</h1>

<div id="group-details" class="box" style="max-width: 900px;">
  Loading...
</div>

<script>
async function loadGroup() {
    const data = await apiRequest("GET", "/api/v1/inventory/group/{{ name }}");
    const group = data.group["{{ name }}"];

    const container = document.getElementById("group-details");

    const type = group.group_type;

    container.innerHTML = `
        <div class="field">
            <label class="label">Group name</label>
            <input id="group_name" class="input" type="text" value="{{ name }}" disabled>
        </div>

        <div class="field">
            <label class="label">Group type</label>
            <div class="select">
                <select id="group_type" disabled>
                    <option value="function">Function group</option>
                    <option value="os">Operating System group</option>
                    <option value="hardware">Hardware group</option>
                    <option value="rack">Rack group</option>
                    <option value="custom">Custom group</option>
                </select>
            </div>
        </div>

        <hr>

        <div id="os-section" style="display:none;"></div>
        <div id="hardware-section" style="display:none;"></div>
        <div id="custom-section" style="display:none;"></div>

        <button class="button is-primary" onclick="saveGroup()">Save</button>
    `;

    document.getElementById("group_type").value = type;

    if (type === "os") {
        renderOsSection(group);
    } else if (type === "hardware") {
        renderHardwareSection(group);
    } else if (type === "custom") {
        renderCustomSection(group);
    }
}

function renderOsSection(group) {
    const os = group.os_operating_system || {};
    const sshKeys = group.os_admin_ssh_keys || [];

    const section = document.getElementById("os-section");
    section.style.display = "block";

    section.innerHTML = `
        <h2 class="subtitle">Operating System settings</h2>

        <div class="field">
            <label class="label">Distribution</label>
            <input id="os_distribution" class="input" type="text" value="${os.distribution || ""}">
        </div>

        <div class="field">
            <label class="label">Distribution version</label>
            <input id="os_distribution_version" class="input" type="text" value="${os.distribution_version || ""}">
        </div>

        <div class="field">
            <label class="label">Distribution major version</label>
            <input id="os_distribution_major_version" class="input" type="text" value="${os.distribution_major_version || ""}">
        </div>

        <div class="field">
            <label class="label">Keyboard layout</label>
            <input id="os_keyboard_layout" class="input" type="text" value="${group.os_keyboard_layout || ""}">
        </div>

        <div class="field">
            <label class="label">System language</label>
            <input id="os_system_language" class="input" type="text" value="${group.os_system_language || ""}">
        </div>

        <div class="field">
            <label class="label">Firewall</label>
            <div class="select">
                <select id="os_firewall">
                    <option value="true">true</option>
                    <option value="false">false</option>
                </select>
            </div>
        </div>

        <div class="field">
            <label class="label">Access control</label>
            <div class="select">
                <select id="os_access_control">
                    <option value="enforcing">enforcing</option>
                    <option value="disabled">disabled</option>
                </select>
            </div>
        </div>

        <div class="field">
            <label class="label">Admin password (SHA512)</label>
            <input id="os_admin_password_sha512" class="input" type="text" value="${group.os_admin_password_sha512 || ""}">
        </div>

        <div class="field">
            <label class="label">Admin SSH keys</label>
            <div id="ssh-keys-container"></div>
            <button class="button is-small is-link" type="button" onclick="addSshKeyField()">Add SSH key</button>
        </div>

        <div class="field">
            <label class="label">Partitioning</label>
            <textarea id="os_partitioning" class="textarea" rows="6">${group.os_partitioning || ""}</textarea>
        </div>

        <div class="field">
            <label class="label">Kernel parameters</label>
            <textarea id="os_kernel_parameters" class="textarea" rows="4">${group.os_kernel_parameters || ""}</textarea>
        </div>
    `;

    document.getElementById("os_firewall").value = group.os_firewall ? "true" : "false";
    document.getElementById("os_access_control").value = group.os_access_control || "enforcing";

    sshKeys.forEach(k => addSshKeyField(k));
}

function renderHardwareSection(group) {
    const hw = group.hw_specs || {};
    const cpu = hw.cpu || {};

    const section = document.getElementById("hardware-section");
    section.style.display = "block";

    section.innerHTML = `
        <h2 class="subtitle">Hardware settings</h2>

        <div class="field">
            <label class="label">Equipment type</label>
            <input id="hw_equipment_type" class="input" type="text" value="${group.hw_equipment_type || ""}">
        </div>

        <h3 class="subtitle">CPU specs</h3>

        <div class="field">
            <label class="label">CPU name</label>
            <input id="hw_cpu_name" class="input" type="text" value="${cpu.name || ""}">
        </div>

        <div class="field">
            <label class="label">Cores</label>
            <input id="hw_cpu_cores" class="input" type="number" value="${cpu.cores || ""}">
        </div>

        <div class="field">
            <label class="label">Cores per socket</label>
            <input id="hw_cpu_cores_per_socket" class="input" type="number" value="${cpu.cores_per_socket || ""}">
        </div>

        <div class="field">
            <label class="label">Sockets</label>
            <input id="hw_cpu_sockets" class="input" type="number" value="${cpu.sockets || ""}">
        </div>

        <div class="field">
            <label class="label">Threads per core</label>
            <input id="hw_cpu_threads_per_core" class="input" type="number" value="${cpu.threads_per_core || ""}">
        </div>

        <div class="field">
            <label class="label">GPU (YAML)</label>
            <textarea id="hw_gpu" class="textarea" rows="4">${hw.gpu || ""}</textarea>
        </div>

        <div class="field">
            <label class="label">Console</label>
            <input id="hw_console" class="input" type="text" value="${group.hw_console || ""}">
        </div>

        <h3 class="subtitle">Board authentication</h3>

        <div class="field">
            <label class="label">Authentication entries (YAML)</label>
            <textarea id="hw_board_authentication" class="textarea" rows="4">${group.hw_board_authentication || ""}</textarea>
        </div>
    `;
}

function renderCustomSection(group) {
    const section = document.getElementById("custom-section");
    section.style.display = "block";

    section.innerHTML = `
        <h2 class="subtitle">Custom variables (YAML)</h2>
        <textarea id="custom_vars" class="textarea" rows="8">${group.custom_vars || ""}</textarea>
    `;
}

function addSshKeyField(initial = "") {
    const container = document.getElementById("ssh-keys-container");

    const div = document.createElement("div");
    div.className = "field";
    div.innerHTML = `
        <div class="control" style="display:flex; gap:0.5rem;">
            <input class="input ssh-key-input" type="text" value="${initial}">
            <button class="button is-small is-danger" type="button" onclick="removeSshKeyField(this)">X</button>
        </div>
    `;

    container.appendChild(div);
}

function removeSshKeyField(button) {
    button.closest(".field").remove();
}

async function saveGroup() {
    const type = document.getElementById("group_type").value;

    const payload = {
        name: "{{ name }}",
        group_type: type
    };

    if (type === "os") {
        const sshKeys = [];
        document.querySelectorAll(".ssh-key-input").forEach(i => {
            const v = i.value.trim();
            if (v) sshKeys.push(v);
        });

        payload.os_operating_system = {
            distribution: document.getElementById("os_distribution").value.trim(),
            distribution_version: document.getElementById("os_distribution_version").value.trim(),
            distribution_major_version: document.getElementById("os_distribution_major_version").value.trim(),
        };
        payload.os_keyboard_layout = document.getElementById("os_keyboard_layout").value.trim();
        payload.os_system_language = document.getElementById("os_system_language").value.trim();
        payload.os_firewall = document.getElementById("os_firewall").value === "true";
        payload.os_access_control = document.getElementById("os_access_control").value;
        payload.os_admin_password_sha512 = document.getElementById("os_admin_password_sha512").value.trim();
        payload.os_admin_ssh_keys = sshKeys;
        payload.os_partitioning = document.getElementById("os_partitioning").value;
        payload.os_kernel_parameters = document.getElementById("os_kernel_parameters").value;
    }

    if (type === "hardware") {
        payload.hw_equipment_type = document.getElementById("hw_equipment_type").value.trim();
        payload.hw_specs = {
            cpu: {
                name: document.getElementById("hw_cpu_name").value.trim(),
                cores: document.getElementById("hw_cpu_cores").value,
                cores_per_socket: document.getElementById("hw_cpu_cores_per_socket").value,
                sockets: document.getElementById("hw_cpu_sockets").value,
                threads_per_core: document.getElementById("hw_cpu_threads_per_core").value,
            },
            gpu: document.getElementById("hw_gpu").value,
        };
        payload.hw_console = document.getElementById("hw_console").value.trim();
        payload.hw_board_authentication = document.getElementById("hw_board_authentication").value;
    }

    if (type === "custom") {
        payload.custom_vars = document.getElementById("custom_vars").value;
    }

    await apiRequest("PUT", "/api/v1/inventory/group/{{ name }}", payload);
    window.location.reload();
}

loadGroup();
</script>
{% endblock %}
