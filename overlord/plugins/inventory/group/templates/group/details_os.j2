{% extends "main.j2" %}

{% block controlbar %}
  <span style="color: var(--overlord-hover-accent); font-weight: bold;">Trace</span> 
  <span style="margin-left: 8px;"><a href="/inventory">Inventory</a> / <a href="/inventory/group">Group</a> / Details / OS</span>
{% endblock %}

{% block headertitle %}
  <h1 class="title is-4">Edit Operating System group {{ name }}</h1>
{% endblock %}

{% block content %}

<div id="os-box" class="box" style="max-width: 800px;">
  Loading...
</div>

<script>
const distroVersions = {
    ubuntu: ["22.04", "24.04"],
    debian: ["12", "13"],
    redhat: ["9", "10"]
};

async function loadGroup() {
    const data = await apiRequest("GET", "/api/v1/inventory/group/{{ name }}");
    const g = data.groups["{{ name }}"]["vars"]["os"];
    const os = g.os_operating_system || {};

    const container = document.getElementById("os-box");

    container.innerHTML = `
        <div class="field">
            <label class="label">Group name</label>
            <input class="input" type="text" value="{{ name }}" disabled>
        </div>

        <hr>

        <h2 class="subtitle">Operating System settings</h2>

        <div class="field">
            <label class="label">Distribution</label>
            <div class="select">
              <select id="os_distribution" onchange="updateVersions()">
                <option value="ubuntu">ubuntu</option>
                <option value="debian">debian</option>
                <option value="redhat">redhat</option>
              </select>
            </div>
        </div>

        <div class="field">
            <label class="label">Distribution version</label>
            <div class="select">
              <select id="os_distribution_version" onchange="updateMajorVersion()"></select>
            </div>
        </div>

        <div class="field">
            <label class="label">Distribution major version</label>
            <input id="os_distribution_major_version" class="input" type="text" readonly>
        </div>

        <div class="field">
            <label class="label">Keyboard layout</label>
            <input id="os_keyboard_layout" class="input" type="text" value="${g.os_keyboard_layout || ""}">
        </div>

        <div class="field">
            <label class="label">System language</label>
            <input id="os_system_language" class="input" type="text" value="${g.os_system_language || ""}">
        </div>

        <div class="field">
            <label class="label">Firewall</label>
            <div class="select">
              <select id="os_firewall">
                <option value="true">true</option>
                <option value="false">false</option>
              </select>
            </div>
        </div>

        <div class="field">
            <label class="label">Access control</label>
            <div class="select">
              <select id="os_access_control">
                <option value="enforcing">enforcing</option>
                <option value="disabled">disabled</option>
              </select>
            </div>
        </div>

        <div class="field">
            <label class="label">Admin password (SHA512)</label>
            <input id="os_admin_password_sha512" class="input" type="text"
                   value="${g.os_admin_password_sha512 || ""}">
        </div>

        <div class="field">
            <label class="label">Admin SSH keys</label>
            <div id="ssh-keys-container"></div>
            <button class="button is-small is-link" onclick="addSshKeyField()">Add SSH key</button>
        </div>

        <div class="field">
            <label class="label">Partitioning</label>
            <textarea id="os_partitioning" class="textarea" rows="6">${g.os_partitioning || ""}</textarea>
        </div>

        <div class="field">
            <label class="label">Kernel parameters</label>
            <textarea id="os_kernel_parameters" class="textarea" rows="4">${g.os_kernel_parameters || ""}</textarea>
        </div>

        <button class="button is-primary" onclick="saveGroup()">Save</button>
    `;

    // Set distribution
    document.getElementById("os_distribution").value = os.distribution || "ubuntu";

    // Populate versions
    updateVersions();

    // Set version
    document.getElementById("os_distribution_version").value =
        os.distribution_version || distroVersions[os.distribution || "ubuntu"][0];

    // Set major version
    updateMajorVersion();

    // Set firewall + access control
    document.getElementById("os_firewall").value = g.os_firewall ? "true" : "false";
    document.getElementById("os_access_control").value = g.os_access_control || "enforcing";

    // Load SSH keys
    (g.os_admin_ssh_keys || []).forEach(k => addSshKeyField(k));
}

function updateVersions() {
    const distro = document.getElementById("os_distribution").value;
    const versionSelect = document.getElementById("os_distribution_version");

    versionSelect.innerHTML = "";
    distroVersions[distro].forEach(v => {
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v;
        versionSelect.appendChild(opt);
    });

    updateMajorVersion();
}

function updateMajorVersion() {
    const version = document.getElementById("os_distribution_version").value;
    const major = version.includes(".") ? version.split(".")[0] : version;
    document.getElementById("os_distribution_major_version").value = major;
}

function addSshKeyField(initial = "") {
    const container = document.getElementById("ssh-keys-container");
    const div = document.createElement("div");
    div.className = "field";
    div.innerHTML = `
        <div class="control" style="display:flex; gap:0.5rem;">
            <input class="input ssh-key-input" type="text" value="${initial}">
            <button class="button is-small is-danger" onclick="removeSshKeyField(this)">X</button>
        </div>
    `;
    container.appendChild(div);
}

function removeSshKeyField(btn) {
    btn.closest(".field").remove();
}

async function saveGroup() {
    const sshKeys = [];
    document.querySelectorAll(".ssh-key-input").forEach(i => {
        const v = i.value.trim();
        if (v) sshKeys.push(v);
    });

    await apiRequest("PUT", "/api/v1/inventory/group/{{ name }}", {
        [name]: {
          group_type: "os",
          vars: {
            os: {
              os_operating_system: {
                  distribution: document.getElementById("os_distribution").value,
                  distribution_version: document.getElementById("os_distribution_version").value,
                  distribution_major_version: document.getElementById("os_distribution_major_version").value,
              },
              os_keyboard_layout: document.getElementById("os_keyboard_layout").value.trim(),
              os_system_language: document.getElementById("os_system_language").value.trim(),
              os_firewall: document.getElementById("os_firewall").value === "true",
              os_access_control: document.getElementById("os_access_control").value,
              os_admin_password_sha512: document.getElementById("os_admin_password_sha512").value.trim(),
              os_admin_ssh_keys: sshKeys,
              os_partitioning: document.getElementById("os_partitioning").value,
              os_kernel_parameters: document.getElementById("os_kernel_parameters").value
            }
          }
        }
        
    });

    window.location.href = "/inventory/group/list";
}

loadGroup();
</script>
{% endblock %}
